---
import { getCollection } from 'astro:content';
import fs from 'fs';
import path from 'path';

export interface Props {
  currentPath: string;
}

const { currentPath } = Astro.props;

// Helper to get file modification time
const getFileModTime = (id: string): number => {
  try {
    const filePath = path.join(process.cwd(), 'src/content/content', id);
    const stats = fs.statSync(filePath);
    return stats.mtimeMs;
  } catch {
    return 0;
  }
};

// Determine current section from path
const getCurrentSection = (path: string) => {
  const parts = path.split('/').filter(Boolean);
  if (parts.length === 0) return null;

  const firstPart = parts[0].toLowerCase();

  // Map paths to sections
  if (firstPart === 'articles') return 'Articles';
  if (firstPart === 'objectives') return 'Objectives';
  if (firstPart === 'projects') return 'Projects';
  if (firstPart === 'resume') return 'Resume';

  return null;
};

const currentSection = getCurrentSection(currentPath);

// Get content for current section
let sectionItems: Array<{ title: string; href: string; description?: string }> = [];

// Check if we're on the index page
const isIndexPage = currentPath === '/' || currentPath === '';

// Helper function to map items to sidebar format
const mapToSidebarItems = (items: any[]) => {
  return items.map(item => {
    let slug = item.id.replace(/\.md$/, '').replace(/\/index$/, '');
    // Normalize first segment to lowercase
    const parts = slug.split('/');
    if (parts[0] === 'Articles' || parts[0] === 'Objectives' || parts[0] === 'Projects' || parts[0] === 'Resume') {
      parts[0] = parts[0].toLowerCase();
    }
    slug = parts.join('/');
    return {
      title: item.data.title,
      href: `/${slug}`,
      description: item.data.description,
    };
  });
};

// Helper function to sort by updated/created date (with file mod time fallback)
const sortByDate = (items: any[]) => {
  return items.sort((a, b) => {
    // Get date from frontmatter or fall back to file modification time
    const dateA = a.data.updated ? new Date(a.data.updated).getTime() :
                  a.data.created ? new Date(a.data.created).getTime() :
                  getFileModTime(a.id);
    const dateB = b.data.updated ? new Date(b.data.updated).getTime() :
                  b.data.created ? new Date(b.data.created).getTime() :
                  getFileModTime(b.id);
    return dateB - dateA;
  });
};

// On index page, show recently updated content from all sections
if (isIndexPage) {
  // Get all published content sorted by updated date
  const allContent = await getCollection('content', ({ data }) => {
    return data.status === 'published' && data.draft !== true;
  });

  sectionItems = mapToSidebarItems(
    sortByDate(allContent.filter(item => item.id !== 'index.md')).slice(0, 10)
  );
} else if (currentSection === 'Articles') {
  const articles = await getCollection('content', ({ data, id }) => {
    return (
      data.type === 'page' &&
      data.status === 'published' &&
      data.draft !== true &&
      id.startsWith('Articles/')
    );
  });

  sectionItems = mapToSidebarItems(
    sortByDate(articles).slice(0, 10)
  );
} else if (currentSection === 'Objectives') {
  const objectives = await getCollection('content', ({ data, id }) => {
    return (
      data.type === 'page' &&
      data.status === 'published' &&
      data.draft !== true &&
      id.startsWith('Objectives/')
    );
  });

  sectionItems = mapToSidebarItems(
    sortByDate(objectives).slice(0, 10)
  );
} else if (currentSection === 'Projects') {
  const projects = await getCollection('content', ({ data, id }) => {
    return (
      data.type === 'project' &&
      data.status === 'published' &&
      data.draft !== true &&
      id.startsWith('Projects/')
    );
  });

  sectionItems = mapToSidebarItems(
    sortByDate(projects).slice(0, 10)
  );
} else if (currentSection === 'Resume') {
  const resumes = await getCollection('content', ({ data, id }) => {
    return (
      data.status === 'published' &&
      data.draft !== true &&
      id.startsWith('Resume/')
    );
  });

  sectionItems = mapToSidebarItems(
    sortByDate(resumes).slice(0, 10)
  );
}

const sectionTitle = (isIndexPage || currentSection) ? 'Recently Updated' : 'Navigation';
---

<div class="p-4 space-y-6">
  <!-- Section Title -->
  <div>
    <h2 class="text-sm font-semibold text-gray-900 dark:text-gray-100 uppercase tracking-wide">
      {sectionTitle}
    </h2>
  </div>

  <!-- Section Contents -->
  {sectionItems.length > 0 ? (
    <div>
      <div class="space-y-2 text-sm">
        {sectionItems.map(item => (
          <a
            href={item.href}
            class:list={[
              'block px-3 py-2 rounded-lg transition-colors',
              currentPath === item.href || currentPath === item.href + '/'
                ? 'bg-blue-100 dark:bg-blue-900 text-blue-900 dark:text-blue-100 font-medium'
                : 'text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800'
            ]}
          >
            <div class="font-medium">{item.title}</div>
            {item.description && (
              <div class="text-xs text-gray-500 dark:text-gray-400 mt-1 line-clamp-2">
                {item.description}
              </div>
            )}
          </a>
        ))}
      </div>
    </div>
  ) : (
    <div class="text-sm text-gray-500 dark:text-gray-400">
      No items in this section
    </div>
  )}

  <!-- Quick Navigation - only show when not on index page and not in a section -->
  {!currentSection && !isIndexPage && (
    <div>
      <h3 class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-2">
        Quick Links
      </h3>
      <div class="space-y-1 text-sm">
        <a href="/" class="block px-2 py-1 rounded hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
          Home
        </a>
        <a href="/articles" class="block px-2 py-1 rounded hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
          Articles
        </a>
        <a href="/objectives" class="block px-2 py-1 rounded hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
          Objectives
        </a>
        <a href="/projects" class="block px-2 py-1 rounded hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
          Projects
        </a>
        <a href="/resume" class="block px-2 py-1 rounded hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
          Resume
        </a>
      </div>
    </div>
  )}
</div>
